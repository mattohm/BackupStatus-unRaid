Menu="Utilities"
Title="status"
Icon="icon.png"
---
<?php
// Path to settings file
$settingsFile = "/boot/config/plugins/BackupStatus/settings.json";
$settings = file_exists($settingsFile) ? json_decode(file_get_contents($settingsFile), true) : [];

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Gather dynamic labels and status file paths
    $entries = [];
    foreach ($_POST['labels'] as $index => $label) {
        $statusFile = $_POST['status_files'][$index] ?? '';
        if (!empty(trim($label)) && !empty(trim($statusFile))) {
            $entries[] = [
                'label' => htmlspecialchars(trim($label)),
                'status_file' => htmlspecialchars(trim($statusFile)),
            ];
        }
    }
    $settings['entries'] = $entries;

    // Save settings to file
    if (!file_put_contents($settingsFile, json_encode($settings))) {
        error_log("Failed to write settings to $settingsFile");
        echo "<script>alert('Failed to save settings. Please check file permissions.');</script>";
    } else {
        echo "<script>alert('Settings updated successfully!');</script>";
    }
}

// Default values
$entries = $settings['entries'] ?? [['label' => 'Backup', 'status_file' => '/path/to/backup_status'], ['label' => 'RClone', 'status_file' => '/path/to/rclone_status']];
?>

<h3>Backup Status Settings</h3>
<form method="POST" action="">
  <div id="entries-container">
    <?php foreach ($entries as $index => $entry): ?>
      <div class="entry-group">
        <label for="label_<?= $index ?>">Label <?= $index + 1 ?>:</label>
        <input type="text" id="label_<?= $index ?>" name="labels[]" value="<?= htmlspecialchars($entry['label']) ?>" required />
        <label for="status_file_<?= $index ?>">Status File:</label>
        <input type="text" id="status_file_<?= $index ?>" name="status_files[]" value="<?= htmlspecialchars($entry['status_file']) ?>" required />
        <button type="button" class="remove-entry" onclick="removeEntry(this)">Remove</button>
      </div>
    <?php endforeach; ?>
  </div>
  <button type="button" id="add-entry">Add Entry</button>
  <div>
    <button type="submit">Save Settings</button>
  </div>
</form>

<hr>

<h3>Backup Status</h3>
<div>
  <?php foreach ($entries as $index => $entry): ?>
    <?php
    // Determine the file's content and set the color accordingly
    $statusFile = $entry['status_file'];
    $statusContent = file_exists($statusFile) ? trim(file_get_contents($statusFile)) : 'Error';
    $color = ($statusContent === '0') ? 'green' : 'red';
    ?>
    <div>
      <span style="color: <?= $color ?>;"><?= date('Y-m-d') ?></span>
      <span><?= htmlspecialchars($entry['label']) ?></span>
      <span>(<?= htmlspecialchars($statusFile) ?>)</span>
    </div>
  <?php endforeach; ?>
</div>

<script>
  document.getElementById('add-entry').addEventListener('click', function() {
    const container = document.getElementById('entries-container');
    const entryCount = container.children.length;
    const newEntryGroup = document.createElement('div');
    newEntryGroup.className = 'entry-group';
    newEntryGroup.innerHTML = `
      <label for="label_${entryCount}">Label ${entryCount + 1}:</label>
      <input type="text" id="label_${entryCount}" name="labels[]" required />
      <label for="status_file_${entryCount}">Status File:</label>
      <input type="text" id="status_file_${entryCount}" name="status_files[]" required />
      <button type="button" class="remove-entry" onclick="removeEntry(this)">Remove</button>
    `;
    container.appendChild(newEntryGroup);
  });

  function removeEntry(button) {
    const entryGroup = button.parentElement;
    entryGroup.remove();
  }
</script>

<style>
  .entry-group {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .entry-group input {
    margin-left: 5px;
    margin-right: 5px;
  }
  .remove-entry {
    background-color: red;
    color: white;
    border: none;
    cursor: pointer;
    padding: 5px 10px;
  }
  #add-entry {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 5px 10px;
    background-color: green;
    color: white;
    border: none;
    cursor: pointer;
  }
</style>

